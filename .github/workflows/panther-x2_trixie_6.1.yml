name: Panther-X2 Armbian (Debian Trixie + 6.1 LTS)

on:
  workflow_dispatch:
    inputs:
      fresh_build:
        description: 'Clean build (ignore all caches)'
        required: false
        type: boolean
        default: false

env:
  BOARD: panther-x2
  BRANCH: current
  KERNEL_VERSION: "6.1.y"
  RELEASE: trixie
  BUILD_TYPE: cli
  BUILD_MINIMAL: "yes"
  LINUXFAMILY: meson-sm1
  BOOT_FDT_FILE: amlogic/meson-sm1-x96-air.dtb

jobs:
  build:
    runs-on: ubuntu-latest
    container: debian:bookworm
    timeout-minutes: 420

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        path: build
        fetch-depth: 0

    - name: Create Non-root User and Setup Environment
      run: |
        # 创建构建用户
        useradd -m -s /bin/bash builder
        chown -R builder:builder /github/workspace/build
        
        # 安装依赖
        apt-get update
        apt-get install -y --no-install-recommends \
          git ca-certificates gnupg lsb-release \
          device-tree-compiler bison flex u-boot-tools \
          python3-pip rsync pv bc kmod lz4 zstd \
          debootstrap qemu-user-static binfmt-support sudo
        
        # 允许builder用户无需密码执行sudo
        echo "builder ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

    - name: Configure Build Settings as Builder User
      run: |
        mkdir -p build/userpatches
        cat <<EOF > build/userpatches/lib.config
        KERNELBRANCH='tag:v${{ env.KERNEL_VERSION }}'
        LINUXFAMILY='${{ env.LINUXFAMILY }}'
        BOOT_FDT_FILE='${{ env.BOOT_FDT_FILE }}'
        IMAGE_PARTITION_TABLE='gpt'
        EOF
      # 关键：切换到builder用户执行
      run-as: builder

    - name: Run Armbian Build as Non-root User
      run: |
        cd /github/workspace/build
        ./compile.sh \
          BOARD="${{ env.BOARD }}" \
          BRANCH="${{ env.BRANCH }}" \
          RELEASE="${{ env.RELEASE }}" \
          BUILD_TYPE="${{ env.BUILD_TYPE }}" \
          BUILD_MINIMAL="${{ env.BUILD_MINIMAL }}"
      # 关键：使用builder用户运行编译脚本
      run-as: builder

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Armbian_Trixie_6.1_PantherX2_$(date +%Y%m%d)
        path: build/output/images/Armbian_*.img.xz
